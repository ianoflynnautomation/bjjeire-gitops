apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: aks-runners
  namespace: actions-runner-system
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: gha-runner-scale-set
      version: 0.10.x
      sourceRef:
        kind: HelmRepository
        name: actions-runner-controller
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Runner scale set configuration
    runnerScaleSetName: aks-runners
    
    # GitHub configuration
    githubConfigUrl: "https://github.com/ianoflynnautomation/gitops-flux-github-runners"
    githubConfigSecret: github-pat
    
    # Scaling configuration
    minRunners: 0
    maxRunners: 15
    
    # Runner group
    runnerGroup: "aks"
    
    # Labels for runner selection
    runnerLabels:
      - self-hosted
      - arc
      - kubernetes
      - linux
      - aks
    
    # Container mode for Kubernetes
    containerMode:
      type: "kubernetes"
      kubernetesModeWorkVolumeClaim:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: managed-csi-premium
    
    # Template for runner pods
    template:
      metadata:
        labels:
          app: github-actions-runner
      spec:
        serviceAccountName: github-runner
        
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:latest
            imagePullPolicy: IfNotPresent
            
            resources:
              requests:
                cpu: "1000m"
                memory: "2Gi"
              limits:
                cpu: "3000m"
                memory: "6Gi"
            
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
              readOnlyRootFilesystem: false  # Runners need to write
              runAsNonRoot: true
              runAsUser: 1001
              seccompProfile:
                type: RuntimeDefault
            
            env:
              - name: RUNNER_FEATURE_FLAGS
                value: "ephemeral"
        
        # Node affinity
        nodeSelector:
          kubernetes.azure.com/agentpool: runners
        
        # Tolerations for dedicated runner nodes
        tolerations:
          - key: runner
            operator: Equal
            value: "true"
            effect: NoSchedule
        
        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          fsGroup: 1001
          seccompProfile:
            type: RuntimeDefault
    
    # Controller service account
    controllerServiceAccount:
      name: actions-runner-controller
      namespace: arc-systems
    
    # Listener configuration
    listenerTemplate:
      metadata:
        labels:
          app: github-actions-listener
      spec:
        containers:
          - name: listener
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
              seccompProfile:
                type: RuntimeDefault