---
name: Validate Flux Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - "kubernetes/**"
      - ".github/workflows/validate.yaml"
      - "scripts/validate.sh"
  push:
    branches: [main]
    paths:
      - "kubernetes/**"
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  KUBERNETES_VERSION: "1.31.0"
  KUSTOMIZE_VERSION: "5.5.0"
  KUBECONFORM_VERSION: "0.6.7"
  FLUX_SCHEMA_DIR: /tmp/flux-crd-schemas/master-standalone-strict

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: kubernetes/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 200
                level: warning
              comments:
                min-spaces-from-content: 1
              truthy:
                check-keys: false
              document-start:
                present: true
              indentation:
                spaces: 2
                indent-sequences: true

  validate-manifests:
    name: Validate Manifests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [yaml-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main
        with:
          version: ${{ env.KUSTOMIZE_VERSION }}

      - name: Setup kubeconform
        uses: fluxcd/pkg/actions/kubeconform@main
        with:
          version: ${{ env.KUBECONFORM_VERSION }}

      - name: Download Flux CRD schemas
        run: |
          mkdir -p "$FLUX_SCHEMA_DIR"
          curl -sL https://github.com/fluxcd/flux2/releases/latest/download/crd-schemas.tar.gz | \
            tar zxf - -C "$FLUX_SCHEMA_DIR"

      - name: Validate Flux Kustomizations
        run: |
          set -e
          echo "::group::Validating Flux Kustomizations"

          while IFS= read -r file; do
            echo "Validating: $file"
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -schema-location default \
              -schema-location "${FLUX_SCHEMA_DIR}/{{ .ResourceKind }}{{ .KindSuffix }}.json" \
              -kubernetes-version "${KUBERNETES_VERSION}" \
              "$file"
          done < <(find kubernetes -name "ks.yaml" -type f)

          echo "::endgroup::"

      - name: Validate HelmReleases
        run: |
          set -e
          echo "::group::Validating HelmReleases"

          while IFS= read -r file; do
            echo "Validating: $file"
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -schema-location default \
              -schema-location "${FLUX_SCHEMA_DIR}/{{ .ResourceKind }}{{ .KindSuffix }}.json" \
              -kubernetes-version "${KUBERNETES_VERSION}" \
              "$file"
          done < <(find kubernetes -name "helmrelease.yaml" -type f)

          echo "::endgroup::"

      - name: Validate Kustomize base manifests
        run: |
          set -e
          echo "::group::Building and validating Kustomize base manifests"

          while IFS= read -r file; do
            dir=$(dirname "$file")
            echo "Building: $dir"
            
            if ! kustomize build "$dir" > /dev/null 2>&1; then
              echo "::warning::Failed to build $dir (may have external dependencies)"
              continue
            fi
          done < <(find kubernetes/apps/base -name "kustomization.yaml" -type f)

          echo "::endgroup::"

      - name: Validate Kustomize overlays
        run: |
          set -e
          echo "::group::Building and validating cluster overlays"

          while IFS= read -r file; do
            dir=$(dirname "$file")
            echo "Building overlay: $dir"
            
            if ! kustomize build --load-restrictor=LoadRestrictionsNone "$dir" > /dev/null; then
              echo "::error::Failed to build overlay $dir"
              kustomize build --load-restrictor=LoadRestrictionsNone "$dir"
              exit 1
            fi
          done < <(find kubernetes/apps/overlays -name "kustomization.yaml" -type f)

          echo "::endgroup::"

      - name: Schema validation with kubeconform
        run: |
          set -e
          echo "::group::Schema validation with kubeconform"

          while IFS= read -r file; do
            dir=$(dirname "$file")
            echo "Validating built manifests from: $dir"
            
            kustomize build "$dir" 2>/dev/null | \
              kubeconform \
                -strict \
                -ignore-missing-schemas \
                -schema-location default \
                -schema-location "${FLUX_SCHEMA_DIR}/{{ .ResourceKind }}{{ .KindSuffix }}.json" \
                -kubernetes-version "${KUBERNETES_VERSION}" \
                -summary
          done < <(find kubernetes/apps/base -name "kustomization.yaml" -type f | head -20)

          echo "::endgroup::"
